(()=>{var a={};a.id=5360,a.ids=[5360],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},42981:(a,b,c)=>{"use strict";c.d(b,{qM:()=>g,zY:()=>f});let d=new Map;function e(a,b={}){let{windowMs:c=6e4,maxRequests:f=10}=b,g=Date.now(),h=d.get(a);return!h||g>h.resetTime?(d.set(a,{count:1,resetTime:g+c}),{allowed:!0}):h.count>=f?{allowed:!1,resetTime:h.resetTime}:(h.count++,{allowed:!0})}function f(a){return e(`webhook:${a}`,{windowMs:6e4,maxRequests:5})}function g(a,b){return e(`api:${b}:${a}`,{windowMs:6e4,maxRequests:30})}setInterval(()=>{let a=Date.now();for(let[b,c]of d.entries())a>c.resetTime&&d.delete(b)},3e5)},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79646:a=>{"use strict";a.exports=require("child_process")},81560:(a,b,c)=>{"use strict";c.d(b,{C:()=>e,J:()=>f});var d=c(10641);function e(a,b){let c=a.headers.get("origin"),d=[process.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000","https://localhost:3000","http://localhost:3000","https://votredomaine.com","https://www.votredomaine.com"];return c&&d.includes(c)?b.headers.set("Access-Control-Allow-Origin",c):c||b.headers.set("Access-Control-Allow-Origin",d[0]),b.headers.set("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),b.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-CSRF-Token"),b.headers.set("Access-Control-Allow-Credentials","true"),b.headers.set("Access-Control-Max-Age","86400"),b}function f(a){return"OPTIONS"===a.method?e(a,new d.NextResponse(null,{status:200})):null}},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87517:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>N,patchFetch:()=>M,routeModule:()=>I,serverHooks:()=>L,workAsyncStorage:()=>J,workUnitAsyncStorage:()=>K});var d={};c.r(d),c.d(d,{OPTIONS:()=>G,POST:()=>H});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(99095),w=c(81560);function x(a){return"string"==typeof a&&a.trim().length>=2&&a.trim().length<=100&&/^[a-zA-Z\s\-'\u00C0-\u017F]+$/.test(a.trim())}function y(a){return"string"==typeof a&&a.trim().length>=5&&a.trim().length<=200&&/^[0-9a-zA-Z\s\-'\.,\u00C0-\u017F]+$/.test(a.trim())}function z(a){return"string"==typeof a&&a.trim().length>=2&&a.trim().length<=100&&/^[a-zA-Z\s\-'\u00C0-\u017F]+$/.test(a.trim())}function A(a){return"string"==typeof a&&/^[0-9]{5}$/.test(a.trim())}function B(a){let b=a.replace(/[\s\.\-]/g,"");return"string"==typeof a&&(/^(\+33|0)[1-9][0-9]{8}$/.test(b)||/^\+?[1-9][0-9]{7,14}$/.test(b))}function C(a){return a.replace(/[<>]/g,"").trim().substring(0,1e3)}var D=c(42981);let E={getBaseUrl:()=>{let a=process.env.NEXT_PUBLIC_SITE_URL;if(a&&""!==a.trim())try{return new URL(a).origin}catch(a){}return"https://flocon.example.com"},getStripeUrls:()=>{let a=E.getBaseUrl();return{success_url:`${a}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${a}/checkout/cancel`}},isValidUrl:a=>{try{let b=new URL(a);return"http:"===b.protocol||"https:"===b.protocol}catch{return!1}},validateImageUrl:a=>{if(!a||"string"!=typeof a)return null;let b=a.trim();if(!b)return null;try{let a=new URL(b);if("https:"!==a.protocol||!a.hostname||"localhost"===a.hostname||"127.0.0.1"===a.hostname)return null;return a.toString()}catch(a){return null}}},F=process.env.STRIPE_SECRET_KEY?new v.A(process.env.STRIPE_SECRET_KEY):null;async function G(a){return(0,w.J)(a)||new u.NextResponse(null,{status:405})}async function H(a){if(!F){let b=u.NextResponse.json({error:"Service de paiement non disponible"},{status:503});return(0,w.C)(a,b)}let b=a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"unknown",c=(0,D.qM)(b,"checkout");if(!c.allowed){let b=u.NextResponse.json({error:"Too many requests"},{status:429});return b.headers.set("Retry-After",Math.ceil((c.resetTime-Date.now())/1e3).toString()),(0,w.C)(a,b)}try{let b=await a.json(),c=function(a){var b,c;let d=[];if(!a||"object"!=typeof a)return d.push("Requ\xeate invalide"),{isValid:!1,errors:d};if(a.customerEmail&&(b=a.customerEmail,/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(b)&&b.length<=255)||d.push("Email invalide : format attendu exemple@domaine.com"),a.shippingAddress&&!((c=a.shippingAddress)&&"object"==typeof c&&x(c.name)&&y(c.address)&&z(c.city)&&A(c.postalCode)&&B(c.phone))){let b=a.shippingAddress;x(b.name)||d.push("Nom complet invalide : 2-100 caract\xe8res, lettres uniquement"),y(b.address)||d.push("Adresse invalide : 5-200 caract\xe8res requis"),z(b.city)||d.push("Ville invalide : 2-100 caract\xe8res, lettres uniquement"),A(b.postalCode)||d.push("Code postal invalide : 5 chiffres requis (ex: 75001)"),B(b.phone)||d.push("T\xe9l\xe9phone invalide : format fran\xe7ais requis (ex: +33 6 12 34 56 78)")}return Array.isArray(a.cartItems)&&0!==a.cartItems.length?a.cartItems.length>50?d.push("Trop d'articles dans le panier"):a.cartItems.forEach((a,b)=>{"object"==typeof a&&"string"==typeof a.id&&a.id.length>0&&a.id.length<=100&&"string"==typeof a.name&&a.name.length>0&&a.name.length<=200&&"number"==typeof a.price&&a.price>0&&a.price<=1e4&&"number"==typeof a.quantity&&a.quantity>0&&a.quantity<=100&&(void 0===a.image||"string"==typeof a.image&&a.image.length<=500)&&(void 0===a.description||"string"==typeof a.description&&a.description.length<=1e3)||d.push(`Article ${b+1} invalide : v\xe9rifiez les informations du produit`)}):d.push("Panier vide ou invalide"),Array.isArray(a.cartItems)&&a.cartItems.reduce((a,b)=>a+b.price*b.quantity,0)>5e4&&d.push("Montant total trop \xe9lev\xe9 : maximum 500â‚¬ par commande"),{isValid:0===d.length,errors:d}}(b);if(!c.isValid){let b=u.NextResponse.json({error:"Donn\xe9es invalides",details:c.errors},{status:400});return(0,w.C)(a,b)}let{cartItems:d,customerEmail:e,shippingAddress:f,metadata:g}={cartItems:b.cartItems.map(a=>({...a,name:C(a.name),description:a.description?C(a.description):void 0})),customerEmail:C(b.customerEmail),shippingAddress:b.shippingAddress||{},metadata:b.metadata||{}},h=d.map((a,b)=>{let c={name:a.name,description:a.description&&a.description.trim()?a.description:`Produit: ${a.name}`};return{price_data:{currency:"eur",product_data:c,unit_amount:Math.round(100*a.price)},quantity:a.quantity}}),i=d.reduce((a,b)=>a+b.price*b.quantity,0),j=E.getStripeUrls(),k=await F.checkout.sessions.create({payment_method_types:["card"],line_items:h,mode:"payment",success_url:j.success_url,cancel_url:j.cancel_url,customer_email:e,metadata:{order_id:`CMD-${Date.now()}`,customer_email:e,items_count:d.length.toString(),total_amount:i.toString(),shipping_name:f.name||e,shipping_address:f.address||"",shipping_city:f.city||"",shipping_postal_code:f.postalCode||"",shipping_phone:f.phone||"",shipping_country:f.country||"FR",...g},payment_method_options:{card:{request_three_d_secure:"automatic"}}}),l=u.NextResponse.json({sessionId:k.id,url:k.url});return(0,w.C)(a,l)}catch(e){let b="Erreur lors de la cr\xe9ation de la session de paiement",c=500;e instanceof Error&&(e.message.includes("Not a valid URL")?(b="URL de redirection invalide - v\xe9rifiez la configuration NEXT_PUBLIC_SITE_URL",c=400):e.message.includes("Invalid image URL")?(b="URL d'image invalide dans les produits du panier",c=400):e.message.includes("No such token")?(b="Cl\xe9 API Stripe invalide",c=401):e.message.includes("amount")&&(b="Montant invalide - v\xe9rifiez les prix des produits",c=400));let d=u.NextResponse.json({error:b,details:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:c});return(0,w.C)(a,d)}}let I=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/create-checkout-session/route",pathname:"/api/create-checkout-session",filename:"route",bundlePath:"app/api/create-checkout-session/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/home/kennedy/Documents/Express/app/api/create-checkout-session/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:J,workUnitAsyncStorage:K,serverHooks:L}=I;function M(){return(0,g.patchFetch)({workAsyncStorage:J,workUnitAsyncStorage:K})}async function N(a,b,c){var d;let e="/api/create-checkout-session/route";"/index"===e&&(e="/");let g=await I.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||I.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===I.isDev||!E,H=E&&!G,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>I.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>I.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await I.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await I.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await I.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,1692,9095],()=>b(b.s=87517));module.exports=c})();